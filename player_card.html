<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>Player Milestone - RAILOKATTA LIVE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@400;700&family=Roboto+Mono:wght@400;500;700&family=Bebas+Neue&family=Montserrat:wght@700;900&display=swap');

        :root {
            --primary-green: #00ff88;
            --primary-blue: #00bfff;
            --dark-bg: #0a1a0a;
            --overlay-dark: rgba(0, 0, 0, 0.85);
            --scoreboard-bg: rgba(0, 0, 0, 0.9);
            --highlight-red: #ff0033;
            --gold: #ffd700;
            --font-main: 'Montserrat', 'Arial Black', sans-serif;
            --font-display: 'Bebas Neue', 'Impact', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { width: 1920px; height: 1080px; overflow: hidden; font-family: 'Roboto Condensed', Arial, sans-serif; background: transparent; position: relative; }

        .stadium-bg { position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, var(--dark-bg) 0%, rgba(0,30,15,0.6) 50%, var(--dark-bg) 100%); pointer-events: none; }
        .light-streak { position: absolute; height: 4px; background: linear-gradient(90deg, transparent 0%, var(--primary-green) 50%, transparent 100%); opacity: 0.6; animation: slideRight 3s ease-in-out infinite; }
        .light-streak.top { top: 50px; width: 800px; left: -800px; }
        .light-streak.middle { top: 150px; width: 600px; left: -600px; background: linear-gradient(90deg, transparent 0%, var(--primary-blue) 50%, transparent 100%); animation-delay: 1s; }
        .light-streak.bottom-left { bottom: 200px; width: 700px; right: -700px; animation: slideLeft 3s ease-in-out infinite; animation-delay: 2s; }
        @keyframes slideRight { 0% { transform: translateX(0); opacity: 0.3; } 50% { opacity: 0.8; } 100% { transform: translateX(2500px); opacity: 0; } }
        @keyframes slideLeft { 0% { transform: translateX(0); opacity: 0.3; } 50% { opacity: 0.8; } 100% { transform: translateX(-2500px); opacity: 0; } }
        .top-curve { position: absolute; top: 0; left: 0; right: 0; height: 200px; background: linear-gradient(180deg, var(--overlay-dark) 0%, transparent 100%); border-bottom: 3px solid var(--primary-green); clip-path: ellipse(100% 100% at 50% 0%); }
        .logo-container { position: absolute; top: 30px; left: 40px; width: 120px; height: 120px; background: transparent; border-radius: 15px; backdrop-filter: blur(10px); border: 2px solid var(--primary-green); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(0, 255, 136, 0.3); animation: pulse 2s ease-in-out infinite; z-index: 10; }
        .logo-container img { max-width: 100px; max-height: 100px; object-fit: contain; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 8px 32px rgba(0, 255, 136, 0.3); } 50% { box-shadow: 0 8px 32px rgba(0, 255, 136, 0.6); } }
        .main-banner { position: absolute; top: 30px; right: 40px; background: linear-gradient(135deg, rgba(0, 50, 30, 0.95) 0%, rgba(0, 30, 20, 0.95) 100%); padding: 14px 40px; border-radius: 12px; border: 2px solid var(--primary-green); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), inset 0 0 30px rgba(0, 255, 136, 0.2); display: flex; align-items: center; gap: 15px; }
        .banner-title { font-family: var(--font-display); font-size: 42px; font-weight: 900; color: #fff; letter-spacing: 3px; text-shadow: 0 0 20px var(--primary-green); font-style: italic; }
        .banner-live { background: var(--highlight-red); color: white; padding: 6px 18px; border-radius: 6px; font-size: 22px; font-weight: 900; animation: liveGlow 1.5s ease-in-out infinite; }
        @keyframes liveGlow { 0%, 100% { box-shadow: 0 0 20px var(--highlight-red); } 50% { box-shadow: 0 0 40px var(--highlight-red); } }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--dark-bg); display: flex; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-text { color: var(--primary-green); font-size: 28px; font-weight: 700; }

        /* ========== PLAYER CARD ========== */
        .card-container {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 900px;
            display: none;
        }

        .milestone-flash {
            animation: milestoneAppear 0.6s ease-out;
        }
        @keyframes milestoneAppear {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .card-header {
            background: linear-gradient(135deg, rgba(0, 50, 30, 0.95), rgba(0, 30, 20, 0.95));
            border: 2px solid var(--primary-green); border-bottom: none;
            border-radius: 20px 20px 0 0;
            padding: 24px 40px;
            text-align: center;
        }
        .milestone-type {
            font-family: var(--font-display); font-size: 36px;
            color: var(--gold); letter-spacing: 6px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .card-body {
            background: var(--scoreboard-bg);
            border: 2px solid rgba(0, 255, 136, 0.3); border-top: none;
            border-radius: 0 0 20px 20px;
            padding: 40px;
            display: flex; flex-direction: column; align-items: center; gap: 30px;
        }

        .player-name {
            font-family: var(--font-display); font-size: 64px;
            color: #fff; letter-spacing: 4px;
            text-shadow: 0 0 20px var(--primary-green);
        }

        .player-score {
            font-family: 'Roboto Mono', monospace; font-size: 96px;
            color: var(--gold); font-weight: 700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }
        .player-score .balls { font-size: 42px; color: rgba(255,255,255,0.5); }

        .player-stats {
            display: flex; gap: 40px; justify-content: center;
        }
        .player-stat {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px 24px;
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 120px;
        }
        .player-stat-label { font-family: 'Oswald', sans-serif; font-size: 16px; color: var(--primary-green); text-transform: uppercase; letter-spacing: 2px; }
        .player-stat-value { font-family: var(--font-display); font-size: 36px; color: #fff; }

        .partnership-info {
            font-size: 22px; color: rgba(255,255,255,0.5);
            text-align: center;
        }

        /* Bowler milestone */
        .bowler-milestone .player-score { color: var(--highlight-red); text-shadow: 0 0 30px rgba(255, 0, 51, 0.5); }
        .bowler-milestone .milestone-type { color: var(--highlight-red); text-shadow: 0 0 20px rgba(255, 0, 51, 0.5); }

        /* No milestone state */
        .waiting-state {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center;
        }
        .waiting-text { font-family: var(--font-display); font-size: 48px; color: rgba(255,255,255,0.15); letter-spacing: 4px; }
        .waiting-sub { font-size: 22px; color: rgba(255,255,255,0.1); margin-top: 10px; }
    </style>
</head>
<body>
    <div class="stadium-bg"></div>
    <div class="light-streak top"></div>
    <div class="light-streak middle"></div>
    <div class="light-streak bottom-left"></div>
    <div class="top-curve"></div>
    <div class="logo-container"><img src="logo.png" alt="Logo" onerror="this.style.display='none'"></div>
    <div class="main-banner"><span class="banner-title">RAILOKATTA</span><span class="banner-live">LIVE</span></div>

    <div class="loading-overlay" id="loadingOverlay"><span class="loading-text">Connecting to score server...</span></div>

    <div class="waiting-state" id="waitingState">
        <div class="waiting-text">PLAYER MILESTONES</div>
        <div class="waiting-sub">Waiting for 50s, 100s, and key wickets...</div>
    </div>

    <div class="card-container" id="cardContainer">
        <div class="card-header">
            <div class="milestone-type" id="milestoneType">--</div>
        </div>
        <div class="card-body" id="cardBody"></div>
    </div>

    <script>
        const API_URL = (window.location.protocol === 'file:' ? 'http://localhost:5555' : window.location.origin) + '/score';
        const REFRESH_INTERVAL = 1500;
        const DEMO_FALLBACK_AFTER = 3;
        let failedAttempts = 0, demoMode = false, isFirstLoad = true;

        // Track milestones already shown to avoid repeat
        let shownMilestones = new Set();
        let currentMilestone = null;
        let milestoneTimer = null;
        const MILESTONE_DISPLAY_MS = 12000; // Show for 12 seconds

        function getDemoData() {
            return {
                matchInfo: { description: 'India vs Pakistan', state: 'InProgress' },
                currentInnings: 2,
                innings: [
                    { id: 2, battingTeam: 'Pakistan', score: 151, wickets: 4, overs: 16.0 }
                ],
                miniscore: {
                    batsmanStriker: { name: 'Babar Azam', runs: 72, balls: 48, fours: 8, sixes: 3, strikeRate: 150.0 },
                    batsmanNonStriker: { name: 'Shadab Khan', runs: 28, balls: 18, fours: 2, sixes: 2, strikeRate: 155.6 },
                    bowlerStriker: { name: 'Jasprit Bumrah', overs: 3, maidens: 0, runs: 24, wickets: 3, economy: 8.00 },
                    partnership: { runs: 53, balls: 30 }
                },
                timestamp: new Date().toISOString(), error: null
            };
        }

        function checkBatterMilestone(bat) {
            if (!bat || !bat.name) return null;
            const key = `bat-${bat.name}-`;
            if (bat.runs >= 150 && !shownMilestones.has(key + '150')) {
                shownMilestones.add(key + '150');
                return { type: '150 RUNS', player: bat, isBowler: false };
            }
            if (bat.runs >= 100 && !shownMilestones.has(key + '100')) {
                shownMilestones.add(key + '100');
                return { type: 'CENTURY', player: bat, isBowler: false };
            }
            if (bat.runs >= 50 && !shownMilestones.has(key + '50')) {
                shownMilestones.add(key + '50');
                return { type: 'HALF CENTURY', player: bat, isBowler: false };
            }
            return null;
        }

        function checkBowlerMilestone(bowl) {
            if (!bowl || !bowl.name) return null;
            const key = `bowl-${bowl.name}-`;
            if (bowl.wickets >= 5 && !shownMilestones.has(key + '5w')) {
                shownMilestones.add(key + '5w');
                return { type: '5 WICKET HAUL', player: bowl, isBowler: true };
            }
            if (bowl.wickets >= 3 && !shownMilestones.has(key + '3w')) {
                shownMilestones.add(key + '3w');
                return { type: '3 WICKETS', player: bowl, isBowler: true };
            }
            return null;
        }

        function showMilestone(milestone, partnership) {
            const container = document.getElementById('cardContainer');
            const body = document.getElementById('cardBody');

            document.getElementById('milestoneType').textContent = milestone.type;
            container.className = 'card-container milestone-flash' + (milestone.isBowler ? ' bowler-milestone' : '');

            if (milestone.isBowler) {
                const p = milestone.player;
                body.innerHTML = `
                    <div class="player-name">${p.name}</div>
                    <div class="player-score">${p.wickets}/${p.runs} <span class="balls">(${p.overs} ov)</span></div>
                    <div class="player-stats">
                        <div class="player-stat"><span class="player-stat-label">Overs</span><span class="player-stat-value">${p.overs}</span></div>
                        <div class="player-stat"><span class="player-stat-label">Maidens</span><span class="player-stat-value">${p.maidens || 0}</span></div>
                        <div class="player-stat"><span class="player-stat-label">Runs</span><span class="player-stat-value">${p.runs}</span></div>
                        <div class="player-stat"><span class="player-stat-label">Economy</span><span class="player-stat-value">${typeof p.economy === 'number' ? p.economy.toFixed(2) : p.economy || '--'}</span></div>
                    </div>
                `;
            } else {
                const p = milestone.player;
                body.innerHTML = `
                    <div class="player-name">${p.name}</div>
                    <div class="player-score">${p.runs}* <span class="balls">(${p.balls} balls)</span></div>
                    <div class="player-stats">
                        <div class="player-stat"><span class="player-stat-label">Fours</span><span class="player-stat-value">${p.fours || 0}</span></div>
                        <div class="player-stat"><span class="player-stat-label">Sixes</span><span class="player-stat-value">${p.sixes || 0}</span></div>
                        <div class="player-stat"><span class="player-stat-label">Strike Rate</span><span class="player-stat-value">${typeof p.strikeRate === 'number' ? p.strikeRate.toFixed(1) : p.strikeRate || '--'}</span></div>
                    </div>
                    ${partnership ? `<div class="partnership-info">Partnership: ${partnership.runs} runs (${partnership.balls} balls)</div>` : ''}
                `;
            }

            container.style.display = '';
            document.getElementById('waitingState').style.display = 'none';

            // Auto-hide after duration
            if (milestoneTimer) clearTimeout(milestoneTimer);
            milestoneTimer = setTimeout(() => {
                container.style.display = 'none';
                document.getElementById('waitingState').style.display = '';
                currentMilestone = null;
            }, MILESTONE_DISPLAY_MS);

            currentMilestone = milestone;
        }

        function processData(data) {
            document.getElementById('loadingOverlay').classList.add('hidden');

            const mini = data.miniscore;
            if (!mini) return;

            // Check for milestones
            const milestone =
                checkBatterMilestone(mini.batsmanStriker) ||
                checkBatterMilestone(mini.batsmanNonStriker) ||
                checkBowlerMilestone(mini.bowlerStriker) ||
                checkBowlerMilestone(mini.bowlerNonStriker);

            if (milestone && (!currentMilestone || currentMilestone.type !== milestone.type || currentMilestone.player.name !== milestone.player.name)) {
                showMilestone(milestone, mini.partnership);
            }

            isFirstLoad = false;
        }

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                failedAttempts = 0;
                if (demoMode) demoMode = false;
                processData(data);
            } catch (e) {
                failedAttempts++;
                if (failedAttempts >= DEMO_FALLBACK_AFTER && !demoMode) demoMode = true;
                if (demoMode) processData(getDemoData());
                else if (isFirstLoad) document.querySelector('.loading-text').textContent = `Connecting... (attempt ${failedAttempts})`;
            }
        }

        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL);
    </script>
</body>
</html>
