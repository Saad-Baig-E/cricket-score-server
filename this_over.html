<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080">
    <title>This Over - RAILOKATTA LIVE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Roboto+Condensed:wght@400;700&family=Roboto+Mono:wght@400;500;700&family=Bebas+Neue&family=Montserrat:wght@700;900&display=swap');

        :root {
            --primary-green: #00ff88;
            --primary-blue: #00bfff;
            --dark-bg: #0a1a0a;
            --overlay-dark: rgba(0, 0, 0, 0.85);
            --scoreboard-bg: rgba(0, 0, 0, 0.9);
            --highlight-red: #ff0033;
            --font-main: 'Montserrat', 'Arial Black', sans-serif;
            --font-display: 'Bebas Neue', 'Impact', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { width: 1920px; height: 1080px; overflow: hidden; font-family: 'Roboto Condensed', Arial, sans-serif; background: transparent; position: relative; }

        .stadium-bg { position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, var(--dark-bg) 0%, rgba(0,30,15,0.6) 50%, var(--dark-bg) 100%); pointer-events: none; }
        .light-streak { position: absolute; height: 4px; background: linear-gradient(90deg, transparent 0%, var(--primary-green) 50%, transparent 100%); opacity: 0.6; animation: slideRight 3s ease-in-out infinite; }
        .light-streak.top { top: 50px; width: 800px; left: -800px; }
        .light-streak.middle { top: 150px; width: 600px; left: -600px; background: linear-gradient(90deg, transparent 0%, var(--primary-blue) 50%, transparent 100%); animation-delay: 1s; }
        .light-streak.bottom-left { bottom: 200px; width: 700px; right: -700px; animation: slideLeft 3s ease-in-out infinite; animation-delay: 2s; }
        @keyframes slideRight { 0% { transform: translateX(0); opacity: 0.3; } 50% { opacity: 0.8; } 100% { transform: translateX(2500px); opacity: 0; } }
        @keyframes slideLeft { 0% { transform: translateX(0); opacity: 0.3; } 50% { opacity: 0.8; } 100% { transform: translateX(-2500px); opacity: 0; } }
        .top-curve { position: absolute; top: 0; left: 0; right: 0; height: 200px; background: linear-gradient(180deg, var(--overlay-dark) 0%, transparent 100%); border-bottom: 3px solid var(--primary-green); clip-path: ellipse(100% 100% at 50% 0%); }
        .logo-container { position: absolute; top: 30px; left: 40px; width: 120px; height: 120px; background: transparent; border-radius: 15px; backdrop-filter: blur(10px); border: 2px solid var(--primary-green); display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(0, 255, 136, 0.3); animation: pulse 2s ease-in-out infinite; z-index: 10; }
        .logo-container img { max-width: 100px; max-height: 100px; object-fit: contain; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 8px 32px rgba(0, 255, 136, 0.3); } 50% { box-shadow: 0 8px 32px rgba(0, 255, 136, 0.6); } }
        .main-banner { position: absolute; top: 30px; right: 40px; background: linear-gradient(135deg, rgba(0, 50, 30, 0.95) 0%, rgba(0, 30, 20, 0.95) 100%); padding: 14px 40px; border-radius: 12px; border: 2px solid var(--primary-green); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6), inset 0 0 30px rgba(0, 255, 136, 0.2); display: flex; align-items: center; gap: 15px; }
        .banner-title { font-family: var(--font-display); font-size: 42px; font-weight: 900; color: #fff; letter-spacing: 3px; text-shadow: 0 0 20px var(--primary-green); font-style: italic; }
        .banner-live { background: var(--highlight-red); color: white; padding: 6px 18px; border-radius: 6px; font-size: 22px; font-weight: 900; animation: liveGlow 1.5s ease-in-out infinite; }
        @keyframes liveGlow { 0%, 100% { box-shadow: 0 0 20px var(--highlight-red); } 50% { box-shadow: 0 0 40px var(--highlight-red); } }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--dark-bg); display: flex; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.5s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-text { color: var(--primary-green); font-size: 28px; font-weight: 700; }

        .panel-container { position: absolute; top: 180px; left: 80px; right: 80px; bottom: 60px; display: flex; flex-direction: column; }
        .panel-header { background: linear-gradient(135deg, rgba(0, 50, 30, 0.95) 0%, rgba(0, 30, 20, 0.95) 100%); border: 2px solid var(--primary-green); border-bottom: none; border-radius: 16px 16px 0 0; padding: 20px 40px; display: flex; align-items: center; justify-content: space-between; }
        .panel-title { font-family: var(--font-display); font-size: 48px; color: #fff; letter-spacing: 4px; text-shadow: 0 0 15px var(--primary-green); }
        .panel-subtitle { font-family: 'Roboto Mono', monospace; font-size: 24px; color: var(--primary-green); }
        .match-score-badge { background: rgba(0, 255, 136, 0.15); border: 1px solid var(--primary-green); border-radius: 8px; padding: 8px 20px; font-family: 'Roboto Mono', monospace; font-size: 22px; color: #fff; }

        .panel-body { background: var(--scoreboard-bg); border: 2px solid rgba(0, 255, 136, 0.3); border-top: none; border-radius: 0 0 16px 16px; flex: 1; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 40px; }

        /* Over info */
        .over-info {
            text-align: center;
        }
        .over-number {
            font-family: var(--font-display); font-size: 72px; color: #fff;
            letter-spacing: 4px;
        }
        .over-matchup {
            font-family: 'Oswald', sans-serif; font-size: 28px; color: var(--primary-green);
            letter-spacing: 2px; margin-top: 8px;
        }

        /* Ball circles */
        .balls-row {
            display: flex; gap: 24px; align-items: center; justify-content: center;
            flex-wrap: wrap;
        }
        .ball-circle {
            width: 100px; height: 100px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-family: var(--font-display); font-size: 42px; font-weight: 700;
            border: 3px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .ball-dot { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.5); border-color: rgba(255,255,255,0.15); }
        .ball-runs { background: rgba(0, 255, 136, 0.15); color: var(--primary-green); border-color: var(--primary-green); }
        .ball-four { background: rgba(0, 191, 255, 0.2); color: var(--primary-blue); border-color: var(--primary-blue); box-shadow: 0 0 20px rgba(0, 191, 255, 0.3); }
        .ball-six { background: rgba(255, 215, 0, 0.2); color: #ffd700; border-color: #ffd700; box-shadow: 0 0 25px rgba(255, 215, 0, 0.4); }
        .ball-wicket { background: rgba(255, 0, 51, 0.2); color: var(--highlight-red); border-color: var(--highlight-red); box-shadow: 0 0 25px rgba(255, 0, 51, 0.4); }
        .ball-wide { background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.2); border-style: dashed; }
        .ball-noball { background: rgba(255, 165, 0, 0.15); color: #ffa500; border-color: #ffa500; border-style: dashed; }
        .ball-empty { background: transparent; border: 3px dashed rgba(255,255,255,0.08); color: rgba(255,255,255,0.1); }

        /* Over summary */
        .over-summary {
            display: flex; gap: 40px; justify-content: center; align-items: center;
            padding: 20px 40px;
            background: linear-gradient(90deg, rgba(0, 50, 30, 0.6), rgba(0, 30, 20, 0.6));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
        }
        .summary-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .summary-label { font-family: 'Oswald', sans-serif; font-size: 18px; color: var(--primary-green); text-transform: uppercase; letter-spacing: 2px; }
        .summary-value { font-family: var(--font-display); font-size: 42px; color: #fff; }
        .summary-value.highlight-runs { color: #ffd700; }

        /* Bowler info */
        .bowler-card {
            display: flex; gap: 30px; align-items: center;
            background: rgba(0,0,0,0.3); border-radius: 12px; padding: 16px 30px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .bowler-name { font-size: 28px; font-weight: 700; color: #fff; }
        .bowler-figures { font-family: 'Roboto Mono', monospace; font-size: 24px; color: var(--primary-blue); }
        .bowler-econ { font-size: 20px; color: rgba(255,255,255,0.5); }

        .no-data { color: rgba(255,255,255,0.3); font-size: 28px; }
    </style>
</head>
<body>
    <div class="stadium-bg"></div>
    <div class="light-streak top"></div>
    <div class="light-streak middle"></div>
    <div class="light-streak bottom-left"></div>
    <div class="top-curve"></div>
    <div class="logo-container"><img src="logo.png" alt="Logo" onerror="this.style.display='none'"></div>
    <div class="main-banner"><span class="banner-title">RAILOKATTA</span><span class="banner-live">LIVE</span></div>

    <div class="loading-overlay" id="loadingOverlay"><span class="loading-text">Connecting to score server...</span></div>

    <div class="panel-container" id="panelContainer" style="display:none;">
        <div class="panel-header">
            <div>
                <div class="panel-title">THIS OVER</div>
                <div class="panel-subtitle" id="panelSubtitle">--</div>
            </div>
            <div class="match-score-badge" id="scoreBadge">--</div>
        </div>
        <div class="panel-body">
            <div class="over-info">
                <div class="over-number" id="overNumber">OVER --</div>
                <div class="over-matchup" id="overMatchup">--</div>
            </div>
            <div class="balls-row" id="ballsRow"></div>
            <div class="over-summary" id="overSummary"></div>
            <div class="bowler-card" id="bowlerCard" style="display:none;">
                <span class="bowler-name" id="bowlerName">--</span>
                <span class="bowler-figures" id="bowlerFigures">--</span>
                <span class="bowler-econ" id="bowlerEcon">--</span>
            </div>
        </div>
    </div>

    <script>
        const API_URL = (window.location.protocol === 'file:' ? 'http://localhost:5555' : window.location.origin) + '/score';
        const REFRESH_INTERVAL = 1500;
        const DEMO_FALLBACK_AFTER = 3;
        let failedAttempts = 0, demoMode = false, isFirstLoad = true;

        function getDemoData() {
            return {
                matchInfo: { description: 'India vs Pakistan, Super 4, Asia Cup 2025', status: 'Pakistan need 42 runs in 24 balls', state: 'InProgress' },
                currentInnings: 2,
                innings: [{ id: 2, battingTeam: 'Pakistan', score: 151, wickets: 4, overs: 16.3 }],
                miniscore: {
                    overs: 16.3,
                    recentOvers: '1 4 0 2 0 1 | 0 6 1 W 0 4 | 4 0 1',
                    bowlerStriker: { name: 'Jasprit Bumrah', overs: 3.3, maidens: 0, runs: 28, wickets: 2, economy: 8.00 },
                    batsmanStriker: { name: 'Shadab Khan' }
                },
                timestamp: new Date().toISOString(), error: null
            };
        }

        function getBallClass(ball) {
            const b = ball.toUpperCase().trim();
            if (b === 'W') return 'ball-wicket';
            if (b === '6') return 'ball-six';
            if (b === '4') return 'ball-four';
            if (b === '0' || b === '.') return 'ball-dot';
            if (b.includes('WD') || b.includes('Wd')) return 'ball-wide';
            if (b.includes('NB') || b.includes('Nb')) return 'ball-noball';
            return 'ball-runs';
        }

        function getBallLabel(ball) {
            const b = ball.toUpperCase().trim();
            if (b === '0' || b === '.') return '0';
            if (b.includes('WD') || b.includes('Wd')) return 'WD';
            if (b.includes('NB') || b.includes('Nb')) return 'NB';
            return ball;
        }

        function processData(data) {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('panelContainer').style.display = '';

            const currentInn = data.innings && data.innings.length > 0 ? data.innings[data.innings.length - 1] : null;
            const mini = data.miniscore;

            const battingTeam = currentInn?.battingTeam || currentInn?.battingTeamShort || '--';
            document.getElementById('panelSubtitle').textContent = battingTeam;
            document.getElementById('scoreBadge').textContent = currentInn
                ? `${battingTeam} ${currentInn.score}/${currentInn.wickets} (${currentInn.overs} ov)` : '--';

            // Parse current over from recentOvers string
            const recentStr = mini?.recentOvers || '';
            const parts = recentStr.split('|').map(s => s.trim()).filter(s => s && s !== '...');
            const currentOverBalls = parts.length > 0 ? parts[parts.length - 1].split(/\s+/).filter(b => b) : [];

            // Over number
            const overs = mini?.overs || currentInn?.overs || 0;
            const overNum = Math.floor(overs);
            document.getElementById('overNumber').textContent = `OVER ${overNum + 1}`;

            // Matchup
            const bowlerName = mini?.bowlerStriker?.name || '--';
            const batsmanName = mini?.batsmanStriker?.name || '--';
            document.getElementById('overMatchup').textContent = `${bowlerName} to ${batsmanName}`;

            // Balls
            const ballsRow = document.getElementById('ballsRow');
            ballsRow.innerHTML = '';

            // Show up to 6 legal balls + extras
            currentOverBalls.forEach(ball => {
                const div = document.createElement('div');
                div.className = `ball-circle ${getBallClass(ball)}`;
                div.textContent = getBallLabel(ball);
                ballsRow.appendChild(div);
            });

            // Fill remaining with empty slots (up to 6)
            const legalBalls = currentOverBalls.filter(b => {
                const u = b.toUpperCase();
                return !u.includes('WD') && !u.includes('NB');
            }).length;
            for (let i = legalBalls; i < 6; i++) {
                const div = document.createElement('div');
                div.className = 'ball-circle ball-empty';
                div.textContent = '-';
                ballsRow.appendChild(div);
            }

            // Over summary
            let totalRuns = 0, wickets = 0, fours = 0, sixes = 0;
            currentOverBalls.forEach(b => {
                const u = b.toUpperCase();
                if (u === 'W') { wickets++; return; }
                const num = parseInt(b);
                if (!isNaN(num)) {
                    totalRuns += num;
                    if (num === 4) fours++;
                    if (num === 6) sixes++;
                }
                if (u.includes('WD')) totalRuns += 1;
                if (u.includes('NB')) totalRuns += 1;
            });

            const summary = document.getElementById('overSummary');
            summary.innerHTML = `
                <div class="summary-item"><span class="summary-label">This Over</span><span class="summary-value ${totalRuns >= 10 ? 'highlight-runs' : ''}">${totalRuns}</span></div>
                <div class="summary-item"><span class="summary-label">Wickets</span><span class="summary-value">${wickets}</span></div>
                <div class="summary-item"><span class="summary-label">Fours</span><span class="summary-value">${fours}</span></div>
                <div class="summary-item"><span class="summary-label">Sixes</span><span class="summary-value">${sixes}</span></div>
                <div class="summary-item"><span class="summary-label">Balls</span><span class="summary-value">${legalBalls}/6</span></div>
            `;

            // Bowler card
            if (mini?.bowlerStriker) {
                const bs = mini.bowlerStriker;
                document.getElementById('bowlerCard').style.display = '';
                document.getElementById('bowlerName').textContent = bs.name;
                document.getElementById('bowlerFigures').textContent = `${bs.overs}-${bs.maidens}-${bs.runs}-${bs.wickets}`;
                document.getElementById('bowlerEcon').textContent = `Econ: ${typeof bs.economy === 'number' ? bs.economy.toFixed(2) : bs.economy}`;
            } else {
                document.getElementById('bowlerCard').style.display = 'none';
            }

            isFirstLoad = false;
        }

        async function fetchData() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                failedAttempts = 0;
                if (demoMode) demoMode = false;
                processData(data);
            } catch (e) {
                failedAttempts++;
                if (failedAttempts >= DEMO_FALLBACK_AFTER && !demoMode) demoMode = true;
                if (demoMode) processData(getDemoData());
                else if (isFirstLoad) document.querySelector('.loading-text').textContent = `Connecting... (attempt ${failedAttempts})`;
            }
        }

        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL);
    </script>
</body>
</html>
